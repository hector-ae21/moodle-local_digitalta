define("local_digitalta/experiences/modals",["exports","local_digitalta/themes/autocomplete","local_digitalta/tags/autocomplete","local_digitalta/tiny/manage","local_digitalta/resources/modals","local_digitalta/repositories/experiences_repository","local_digitalta/repositories/resources_repository","local_digitalta/repositories/sections_repository","local_digitalta/repositories/languages_repository","core/normalise","core/config","core/str","core/modal","core/modal_events","core/modal_factory","core/modal_registry","core/notification","../tiny/manage"],(function(_exports,_autocomplete,_autocomplete2,_manage,_modals,_experiences_repository,_resources_repository,_sections_repository,_languages_repository,_normalise,Cfg,Str,_modal,_modal_events,_modal_factory,_modal_registry,_notification,_manage2){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _getRequireWildcardCache(nodeInterop){if("function"!=typeof WeakMap)return null;var cacheBabelInterop=new WeakMap,cacheNodeInterop=new WeakMap;return(_getRequireWildcardCache=function(nodeInterop){return nodeInterop?cacheNodeInterop:cacheBabelInterop})(nodeInterop)}function _interopRequireWildcard(obj,nodeInterop){if(!nodeInterop&&obj&&obj.__esModule)return obj;if(null===obj||"object"!=typeof obj&&"function"!=typeof obj)return{default:obj};var cache=_getRequireWildcardCache(nodeInterop);if(cache&&cache.has(obj))return cache.get(obj);var newObj={},hasPropertyDescriptor=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var key in obj)if("default"!==key&&Object.prototype.hasOwnProperty.call(obj,key)){var desc=hasPropertyDescriptor?Object.getOwnPropertyDescriptor(obj,key):null;desc&&(desc.get||desc.set)?Object.defineProperty(newObj,key,desc):newObj[key]=obj[key]}return newObj.default=obj,cache&&cache.set(obj,newObj),newObj}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.showUnlockModal=_exports.showUnlinkResourceModal=_exports.showManageShareModal=_exports.showManageReflectionModal=_exports.showManageModal=_exports.showManageAskModal=_exports.showLockModal=_exports.displayManageReflectionModal=_exports.displayManageModal=_exports.displayLinkResourcesModal=_exports.displayLinkResourceModal=void 0,Cfg=_interopRequireWildcard(Cfg),Str=_interopRequireWildcard(Str),_modal=_interopRequireDefault(_modal),_modal_events=_interopRequireDefault(_modal_events),_modal_factory=_interopRequireDefault(_modal_factory),_modal_registry=_interopRequireDefault(_modal_registry),_notification=_interopRequireDefault(_notification);const manageModal=class extends _modal.default{static TYPE="local_digitalta/manageModal";static TEMPLATE="local_digitalta/experiences/modals/modal-manage";registerEventListeners(){super.registerEventListeners(),this.registerCloseOnSave(),this.registerCloseOnCancel()}};_modal_registry.default.register(manageModal.TYPE,manageModal,manageModal.TEMPLATE);const lockModal=class extends _modal.default{static TYPE="local_digitalta/lockModal";static TEMPLATE="local_digitalta/experiences/modals/modal-lock";registerEventListeners(){super.registerEventListeners(),this.registerCloseOnSave(),this.registerCloseOnCancel()}};_modal_registry.default.register(lockModal.TYPE,lockModal,lockModal.TEMPLATE);const unlockModal=class extends _modal.default{static TYPE="local_digitalta/unlockModal";static TEMPLATE="local_digitalta/experiences/modals/modal-lock";registerEventListeners(){super.registerEventListeners(),this.registerCloseOnSave(),this.registerCloseOnCancel()}};_modal_registry.default.register(unlockModal.TYPE,unlockModal,unlockModal.TEMPLATE);const manageReflectionModal=class extends _modal.default{static TYPE="local_digitalta/manageReflectionModal";static TEMPLATE="local_digitalta/experiences/modals/modal-reflection";registerEventListeners(){super.registerEventListeners(),this.registerCloseOnSave(),this.registerCloseOnCancel()}};_modal_registry.default.register(manageReflectionModal.TYPE,manageReflectionModal,manageReflectionModal.TEMPLATE);const linkResourcesModal=class extends _modal.default{static TYPE="local_digitalta/linkResourcesModal";static TEMPLATE="local_digitalta/experiences/modals/modal-resources";registerEventListeners(){super.registerEventListeners(),this.registerCloseOnSave(),this.registerCloseOnCancel()}};_modal_registry.default.register(linkResourcesModal.TYPE,linkResourcesModal,linkResourcesModal.TEMPLATE);const linkResourceModal=class extends _modal.default{static TYPE="local_digitalta/linkResourceModal";static TEMPLATE="local_digitalta/experiences/modals/modal-resource-link";registerEventListeners(){super.registerEventListeners(),this.registerCloseOnSave(),this.registerCloseOnCancel()}};_modal_registry.default.register(linkResourceModal.TYPE,linkResourceModal,linkResourceModal.TEMPLATE);const unlinkResourceModal=class extends _modal.default{static TYPE="local_digitalta/unlinkResourceModal";static TEMPLATE="local_digitalta/experiences/modals/modal-resource-unlink";registerEventListeners(){super.registerEventListeners(),this.registerCloseOnSave(),this.registerCloseOnCancel()}};_modal_registry.default.register(unlinkResourceModal.TYPE,unlinkResourceModal,unlinkResourceModal.TEMPLATE);_exports.showManageAskModal=async function(){let experienceid=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;const string_keys=[{key:"teacheracademy:actions:ask",component:"local_digitalta"},{key:"teacheracademy:actions:ask:description",component:"local_digitalta"},{key:"teacheracademy:actions:ask:title",component:"local_digitalta"},{key:"teacheracademy:actions:ask:title:placeholder",component:"local_digitalta"},{key:"teacheracademy:actions:ask:visibility",component:"local_digitalta"},{key:"teacheracademy:actions:ask:language",component:"local_digitalta"},{key:"teacheracademy:actions:ask:themes",component:"local_digitalta"},{key:"teacheracademy:actions:ask:tags",component:"local_digitalta"},{key:"teacheracademy:actions:ask:picture",component:"local_digitalta"},{key:"visibility:public",component:"local_digitalta"},{key:"visibility:private",component:"local_digitalta"}];showManageModal(experienceid,string_keys)};_exports.showManageShareModal=async function(){let experienceid=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;const string_keys=[{key:"teacheracademy:actions:share",component:"local_digitalta"},{key:"teacheracademy:actions:share:description",component:"local_digitalta"},{key:"teacheracademy:actions:share:title",component:"local_digitalta"},{key:"teacheracademy:actions:share:title:placeholder",component:"local_digitalta"},{key:"teacheracademy:actions:share:visibility",component:"local_digitalta"},{key:"teacheracademy:actions:share:language",component:"local_digitalta"},{key:"teacheracademy:actions:share:themes",component:"local_digitalta"},{key:"teacheracademy:actions:share:tags",component:"local_digitalta"},{key:"teacheracademy:actions:share:picture",component:"local_digitalta"},{key:"visibility:public",component:"local_digitalta"},{key:"visibility:private",component:"local_digitalta"}];showManageModal(experienceid,string_keys)};const showManageModal=async function(){let experienceid=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,string_keys=arguments.length>1?arguments[1]:void 0;const strings=await Str.get_strings(string_keys),languages=await(0,_languages_repository.languagesGet)({prioritizeInstalled:!0}),experience=null===experienceid?Promise.resolve({}):await(0,_experiences_repository.experiencesGet)(experienceid).then((response=>response.experience));Promise.all([strings,languages,experience]).then((_ref=>{let[strings,languages,experience]=_ref;return displayManageModal(strings,languages,experience)}))};_exports.showManageModal=showManageModal;const displayManageModal=async function(strings,languages){let experience=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},anyLanguageSelected=!1;languages=languages.map((language=>(language.selected=!1,experience.hasOwnProperty("lang")&&language.code===experience.lang&&(language.selected=anyLanguageSelected=!0),{key:language.code,value:language.name,selected:language.selected}))),anyLanguageSelected||(languages[0].selected=!0);let sections={};experience.sections&&experience.sections.forEach((section=>{sections[section.groupname_simplified]=section})),experience.sections=sections;let visibility=[{key:1,value:strings[9]},{key:0,value:strings[10]}],anyVisibilitySelected=!1;visibility=visibility.map((item=>(item.selected=!1,experience.hasOwnProperty("visible")&&item.key===experience.visible&&(item.selected=anyVisibilitySelected=!0),{key:item.key,value:item.value,selected:item.key===experience.visible}))),anyVisibilitySelected||(visibility[0].selected=!0);const modal=await _modal_factory.default.create({type:manageModal.TYPE,templateContext:{modal:{title:strings[0],description:strings[1],sections:{title:{label:strings[2],placeholder:strings[3]},visibility:{label:strings[4]},language:{label:strings[5]},themes:{label:strings[6]},tags:{label:strings[7]},picture:{label:strings[8]}},visibility:visibility,languages:languages},current:{id:experience.id??0,title:experience.title??null,visible:experience.visible??null,lang:experience.lang??null,sections:experience.sections??[],tags:experience.tags??[],themes:experience.themes??[]}},large:!0,removeOnClose:!0});modal.show();const $root=modal.getRoot();(0,_manage.createTinyMCE)("experience-manage-reflection-what-content"),(0,_autocomplete2.autocompleteTags)("#experience-manage-tags"),(0,_autocomplete.autocompleteThemes)("#experience-manage-themes"),$root.on(_modal_events.default.save,((event,modal)=>{event.preventDefault();const form=$root[0].querySelector("form");validateManageRequiredFields(form)&&handleManageModalSubmission(event,modal)}))};_exports.displayManageModal=displayManageModal;const handleManageModalSubmission=async(event,modal)=>{const form=(0,_normalise.getList)(modal.getRoot())[0].querySelector("form");if(!form)return;const formData={id:form.querySelector('input[name="experience-manage-id"]').value,title:form.querySelector('input[name="experience-manage-title"]').value,visible:form.querySelector('select[name="experience-manage-visibility"]').value,lang:form.querySelector('select[name="experience-manage-lang"]').value,sections:[{id:form.querySelector('textarea[name="experience-manage-reflection-what-content"]').getAttribute("data-id")||null,groupid:form.querySelector('textarea[name="experience-manage-reflection-what-content"]').getAttribute("data-groupid")||null,groupname:form.querySelector('textarea[name="experience-manage-reflection-what-content"]').getAttribute("data-groupname")||null,typename:"text",content:(0,_manage.getTinyMCEContent)("experience-manage-reflection-what-content")}],themes:Array.from(form.querySelectorAll('select[name="experience-manage-themes"] option:checked'),(option=>option.value)),tags:Array.from(form.querySelectorAll('select[name="experience-manage-tags"] option:checked'),(option=>option.value))};try{formData.sections[0].content=await(0,_manage2.processFiles)(formData.sections[0].content);const response=await(0,_experiences_repository.experiencesUpsert)(formData);_notification.default.addNotification({message:"Experience saved successfully.",type:"success"}),location.href=Cfg.wwwroot+"/local/digitalta/pages/experiences/view.php?id="+response.experienceid}catch(error){_notification.default.exception(error)}},validateManageRequiredFields=form=>{const requiredFields=form.querySelectorAll("input[required], select[required], textarea[required]");for(const field of requiredFields)if(!field.value)return field.focus(),!1;return!0};_exports.showLockModal=async experienceid=>{const strings=Str.get_strings([{key:"experience:lock",component:"local_digitalta"},{key:"experience:lock:confirm",component:"local_digitalta"}]);Promise.all([strings]).then((_ref2=>{let[strings]=_ref2;return displayLockModal(strings,experienceid)}))};_exports.showUnlockModal=async experienceid=>{const strings=Str.get_strings([{key:"experience:unlock",component:"local_digitalta"},{key:"experience:unlock:confirm",component:"local_digitalta"}]);Promise.all([strings]).then((_ref3=>{let[strings]=_ref3;return displayLockModal(strings,experienceid)}))};const displayLockModal=async(strings,experienceid)=>{const modal=await _modal_factory.default.create({type:lockModal.TYPE,templateContext:{modal:{title:strings[0],description:strings[1]}},large:!1,removeOnClose:!0});modal.show();modal.getRoot().on(_modal_events.default.save,(event=>{event.preventDefault(),(0,_experiences_repository.experiencesToggleStatus)(experienceid),modal.destroy(),window.location.reload()}))};_exports.showManageReflectionModal=async experienceid=>{const strings=Str.get_strings([{key:"experience:reflection:title",component:"local_digitalta"},{key:"experience:reflection:description",component:"local_digitalta"}]),experience=null===experienceid?Promise.resolve({}):await(0,_experiences_repository.experiencesGet)(experienceid).then((response=>response.experience));Promise.all([strings,experience]).then((_ref4=>{let[strings,experience]=_ref4;return displayManageReflectionModal(strings,experience)}))};const displayManageReflectionModal=async(strings,experience)=>{let sections={};experience.sections.forEach((section=>{sections[section.groupname_simplified]=section})),experience.sections=sections;const modal=await _modal_factory.default.create({type:manageReflectionModal.TYPE,templateContext:{modal:{title:strings[0],description:strings[1]},experienceid:experience.id??0,sections:experience.sections??[]},large:!0,removeOnClose:!0});modal.show();const $root=modal.getRoot();(0,_manage.createTinyMCE)("experience-manage-reflection-what-content"),(0,_manage.createTinyMCE)("experience-manage-reflection-so_what-content"),(0,_manage.createTinyMCE)("experience-manage-reflection-now_what-content"),$root.on(_modal_events.default.save,((event,modal)=>{event.preventDefault();const form=$root[0].querySelector("form");validateManageRequiredFields(form)&&handleManageReflectionModalSubmission(event,modal)}))};_exports.displayManageReflectionModal=displayManageReflectionModal;const handleManageReflectionModalSubmission=async(event,modal)=>{const form=(0,_normalise.getList)(modal.getRoot())[0].querySelector("form");if(!form)return;const formData={id:form.querySelector('input[name="experience-manage-id"]').value,sections:[{id:form.querySelector('textarea[name="experience-manage-reflection-what-content"]').getAttribute("data-id"),groupid:form.querySelector('textarea[name="experience-manage-reflection-what-content"]').getAttribute("data-groupid"),content:(0,_manage.getTinyMCEContent)("experience-manage-reflection-what-content")},{id:form.querySelector('textarea[name="experience-manage-reflection-so_what-content"]').getAttribute("data-id"),groupid:form.querySelector('textarea[name="experience-manage-reflection-so_what-content"]').getAttribute("data-groupid"),content:(0,_manage.getTinyMCEContent)("experience-manage-reflection-so_what-content")},{id:form.querySelector('textarea[name="experience-manage-reflection-now_what-content"]').getAttribute("data-id"),groupid:form.querySelector('textarea[name="experience-manage-reflection-now_what-content"]').getAttribute("data-groupid"),content:(0,_manage.getTinyMCEContent)("experience-manage-reflection-now_what-content")}]};try{let promises=[];for(const section of formData.sections)section.content=await(0,_manage2.processFiles)(section.content),promises.push((0,_sections_repository.sectionsUpsert)({id:section.id,component:"experience",componentinstance:formData.id,groupid:section.groupid,groupname:null,sequence:null,type:null,typename:"text",title:null,content:section.content}));await Promise.all(promises),_notification.default.addNotification({message:"Reflection saved successfully.",type:"success"}),location.href=Cfg.wwwroot+"/local/digitalta/pages/experiences/view.php?id="+formData.id}catch(error){_notification.default.exception(error)}};_exports.displayLinkResourcesModal=async function(){let experienceid=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null;const{resources:resources}=await(0,_resources_repository.resourcesGet)({}),modal=await _modal_factory.default.create({type:linkResourcesModal.TYPE,templateContext:{experienceid:experienceid,resources:resources},large:!0,removeOnClose:!0});modal.show();const $root=modal.getRoot(),changeElement=$root.find("#changeToManageResource").get(0);changeElement&&(changeElement.onclick=()=>{(0,_modals.showManageResourcesModal)(null,experienceid),modal.destroy()})};_exports.displayLinkResourceModal=async(experienceid,resourceid)=>{const resource=await(0,_resources_repository.resourcesGet)({id:resourceid}).then((response=>response.resources[0])),modal=await _modal_factory.default.create({type:linkResourceModal.TYPE,templateContext:{experienceid:experienceid,resourceid:resource.id,resourcename:resource.name},large:!0,removeOnClose:!0});modal.show();const $root=modal.getRoot();(0,_manage.createTinyMCE)("experience-link-resource-description"),$root.on(_modal_events.default.save,((event,modal)=>{handleLinkResourceModalSubmission(event,modal)}))};const handleLinkResourceModalSubmission=async(event,modal)=>{const form=(0,_normalise.getList)(modal.getRoot())[0].querySelector("form");if(!form)return;const formData={resourceid:form.querySelector('input[name="resourceid"]').value,component:"experience",componentinstance:form.querySelector('input[name="experienceid"]').value,description:(0,_manage.getTinyMCEContent)("experience-link-resource-description")};try{formData.description=await(0,_manage2.processFiles)(formData.description),await(0,_resources_repository.resourcesAssign)(formData),_notification.default.addNotification({message:"Resource linked successfully.",type:"success"}),location.reload()}catch(error){_notification.default.exception(error)}};_exports.showUnlinkResourceModal=async(experienceid,resourceid)=>{const strings=Str.get_strings([{key:"experience:resources:unlink",component:"local_digitalta"},{key:"experience:resources:unlink:confirm",component:"local_digitalta"}]);Promise.all([strings]).then((_ref5=>{let[strings]=_ref5;return displayUnlinkResourceModal(strings,experienceid,resourceid)}))};const displayUnlinkResourceModal=async(strings,experienceid,resourceid)=>{const modal=await _modal_factory.default.create({type:lockModal.TYPE,templateContext:{modal:{title:strings[0],description:strings[1]}},large:!1,removeOnClose:!0});modal.show();modal.getRoot().on(_modal_events.default.save,(async(event,modal)=>{event.preventDefault();try{await(0,_resources_repository.resourcesUnassign)({id:resourceid,component:"experience",componentinstance:experienceid}),_notification.default.addNotification({message:"Resource unlinked successfully.",type:"success"}),modal.destroy(),window.location.reload()}catch(error){_notification.default.exception(error)}}))}}));

//# sourceMappingURL=modals.min.js.map