define("local_digitalta/resources/provider",["exports","core/templates","jquery","core/ajax","core/notification","../commun/utils"],(function(_exports,_templates,_jquery,_ajax,_notification,_utils){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_templates=_interopRequireDefault(_templates),_jquery=_interopRequireDefault(_jquery),_ajax=_interopRequireDefault(_ajax);let pages=0,filters=[],selectedPage=1;_exports.init=()=>{(0,_jquery.default)('[data-section-name="digitalta-resources-list"]  .dropdown-menu').on("click",(function(e){e.stopPropagation()})),getAndRenderFilters(),setActionsFilters(),getResources()};const getAndRenderFilters=async()=>{const themesResponse=await _ajax.default.call([{methodname:"local_digitalta_themes_get",args:{}}])[0],tagsResponse=await _ajax.default.call([{methodname:"local_digitalta_tags_get",args:{}}])[0],languagesResponse=await _ajax.default.call([{methodname:"local_digitalta_resources_get_used_langs",args:{}}])[0],resourcesTypeResponse=await _ajax.default.call([{methodname:"local_digitalta_resources_types_get",args:{}}])[0],templateFilterThemes=await _templates.default.renderForPromise("local_digitalta/_common/filterTheme",{themes:themesResponse}),templateFilterLanguages=await _templates.default.renderForPromise("local_digitalta/_common/filterLanguages",{languages:languagesResponse}),templateFilterTypes=await _templates.default.renderForPromise("local_digitalta/_common/filterResourceTypes",{types:resourcesTypeResponse.types});_templates.default.replaceNodeContents("#filterThemeSelect",templateFilterThemes.html,templateFilterThemes.js),_templates.default.replaceNodeContents("#filterLanguageSelect",templateFilterLanguages.html,templateFilterLanguages.js),_templates.default.replaceNodeContents("#filterResourceSelect",templateFilterTypes.html,templateFilterTypes.js);const availableTags=tagsResponse.map((function(tag){return tag.name}));(0,_jquery.default)("#inlineFormInputGroup").on("input",(async function(){var input=(0,_jquery.default)(this).val().toLowerCase(),suggestions=availableTags.filter((function(tag){return tag.toLowerCase().startsWith(input)}));const templateFilterTags=await _templates.default.renderForPromise("local_digitalta/_common/listTags",{tags:suggestions});_templates.default.replaceNodeContents("#suggestionsTags",templateFilterTags.html,templateFilterTags.js)}))},setActionsFilters=()=>{(0,_jquery.default)(document).on("change","#filterResourceType",(function(){const selectedId=(0,_jquery.default)("option:selected.enable",this).val(),selectedText=(0,_jquery.default)("option:selected.enable",this).text();if(selectedText.length>0){const element=(0,_jquery.default)("option:selected.enable",this);element.addClass("disabled"),element.removeClass("enable");setFilter({type:"resource",value:{id:selectedId,name:selectedText}}),(0,_jquery.default)("#filterResourceType option:first").prop("selected",!0),(0,_jquery.default)(element).prop("disabled",!0)}})),(0,_jquery.default)(document).on("click","li.page-item.page-link.page",(function(){const clickedPage=(0,_jquery.default)(this).attr("attr-page");selectedPage!==clickedPage&&(selectedPage=parseInt(clickedPage),getResources())})),(0,_jquery.default)(document).on("click","li.page-item.page-link.state",(function(){const state=(0,_jquery.default)(this).attr("aria-label");if("Next"===state){const posibleNextPage=selectedPage+1;posibleNextPage>0&&posibleNextPage<=pages&&(selectedPage++,getResources())}else if("Previous"===state){const posiblePreviousPage=selectedPage-1;posiblePreviousPage>0&&posiblePreviousPage<=pages&&(selectedPage--,getResources())}})),(0,_jquery.default)(document).on("change",".filterThemeSelect",(function(){const selectedValue=(0,_jquery.default)("option:selected.enable",this).val(),selectedText=(0,_jquery.default)("option:selected.enable",this).text();if(selectedText.length>0){const element=(0,_jquery.default)("option:selected.enable",this);element.addClass("disabled"),element.removeClass("enable");setFilter({type:"theme",value:{id:selectedValue,name:selectedText}}),(0,_jquery.default)(".filterThemeSelect option:first").prop("selected",!0),(0,_jquery.default)(element).prop("disabled",!0)}})),(0,_jquery.default)("#suggestionsTags").on("click",".tag-item",(function(){const filterText={type:"tag",value:(0,_jquery.default)(this).attr("attr-name")};setFilter(filterText),(0,_jquery.default)("#inlineFormInputGroup").val("")})),(0,_jquery.default)(document).on("keydown","#authorFilters",(async function(){const request={methodname:"core_enrol_get_potential_users",args:{courseid:1,enrolid:1,page:0,perpage:10,search:(0,_jquery.default)(this).val(),searchanywhere:!0}},response=await _ajax.default.call([request])[0];if(0===response.length)(0,_jquery.default)("#suggestionsAuthors").empty();else{const authorsSuggestions=await _templates.default.renderForPromise("local_digitalta/_common/listAuthors",{users:response});_templates.default.replaceNodeContents("#suggestionsAuthors",authorsSuggestions.html,authorsSuggestions.js)}})),(0,_jquery.default)("#suggestionsAuthors").on("click",".author-item",(function(){const filterText={type:"author",value:{id:(0,_jquery.default)(this).attr("attr-id-user"),name:(0,_jquery.default)(this).attr("attr-name")}};setFilter(filterText),(0,_jquery.default)("#authorFilters").val("")})),(0,_jquery.default)(document).on("change",".filterLanguageSelect",(function(){const selectedText=(0,_jquery.default)("option:selected.enable",this).text();if(selectedText.length>0){const element=(0,_jquery.default)("option:selected.enable",this);element.addClass("disabled"),element.removeClass("enable");setFilter({type:"language",value:selectedText}),(0,_jquery.default)(".filterLanguageSelect option:first").prop("selected",!0),(0,_jquery.default)(element).prop("disabled",!0)}})),(0,_jquery.default)("#filters-menu").click((function(){(0,_jquery.default)(".tagsInputFilter").is(":focus")?((0,_jquery.default)("#suggestionsAuthors").hide(),(0,_jquery.default)("#suggestionsTags").show()):(0,_jquery.default)("#authorFilters").is(":focus")?((0,_jquery.default)("#suggestionsTags").hide(),(0,_jquery.default)("#suggestionsAuthors").show()):((0,_jquery.default)("#suggestionsTags").hide(),(0,_jquery.default)("#suggestionsAuthors").hide())})),(0,_jquery.default)(document).on("click","#removeFilter",(function(){const filterText=(0,_jquery.default)(this).attr("attr-filter"),filterType=(0,_jquery.default)(this).attr("attr-type");removeFilter({type:filterType,value:filterText})}))},removeFilter=filterObject=>{const index=filters.findIndex((filter=>"author"===filter.type||"resource"===filter.type||"theme"===filter.type?filter.type===filterObject.type&&filter.value.name===filterObject.value:filter.type===filterObject.type&&filter.value===filterObject.value));if(index>-1){if("theme"===filterObject.type){let themeSelect=(0,_jquery.default)("#filterThemes"),option=(0,_jquery.default)('option[value="'+filters[index].value.id+'"].disabled',themeSelect);option.removeClass("disabled"),option.addClass("enable"),(0,_jquery.default)("#filterThemes option:first").prop("selected",!0),(0,_jquery.default)(option).prop("disabled",!1)}else if("language"===filterObject.type){let langSelect=(0,_jquery.default)(".filterLanguageSelect"),option=(0,_jquery.default)('option[value="'+filterObject.value+'"].disabled',langSelect);option.removeClass("disabled"),option.addClass("enable"),(0,_jquery.default)(".filterLanguageSelect option:first").prop("selected",!0),(0,_jquery.default)(option).prop("disabled",!1)}else if("resource"===filterObject.type){let resourceSelect=(0,_jquery.default)("#filterResourceType"),option=(0,_jquery.default)('option[value="'+filters[index].value.id+'"].disabled',resourceSelect);option.removeClass("disabled"),option.addClass("enable"),(0,_jquery.default)("#filterResourceType option:first").prop("selected",!0),(0,_jquery.default)(option).prop("disabled",!1)}filters.splice(index,1),selectedPage=1,renderFilters()}},setFilter=filterObject=>{filters.push(filterObject),selectedPage=1,renderFilters()},renderFilters=()=>{getResources();const filtersMap=filters.map((filter=>"author"===filter.type||"resource"===filter.type||"theme"===filter.type?{type:filter.type,value:filter.value.name}:{type:filter.type,value:filter.value}));_templates.default.renderForPromise("local_digitalta/_common/filterList",{filters:filtersMap}).then((_ref=>{let{html:html,js:js}=_ref;_templates.default.replaceNodeContents("#filtersList",html,js)})).catch((error=>(0,_notification.exception)(error)))},getResources=async()=>{const mappedFilters=filters.map((filter=>"author"===filter.type||"resource"===filter.type||"theme"===filter.type?{type:filter.type,value:filter.value.id}:filter)),resourcesRequest={methodname:"local_digitalta_resources_get_by_pagination",args:{filters:JSON.stringify(mappedFilters),pagenumber:selectedPage}},resourcesResponse=await _ajax.default.call([resourcesRequest])[0];if(0===resourcesResponse.data.length)_templates.default.renderForPromise("local_digitalta/_common/empty-view",resourcesResponse).then((_ref2=>{let{html:html,js:js}=_ref2;_templates.default.replaceNodeContents("#list-resources-body",html,js)})).catch((error=>(0,_notification.exception)(error))),(0,_jquery.default)(".digitalta.pagination").hide();else{let obj={resources:resourcesResponse,viewtagurl:M.cfg.wwwroot+"/local/digitalta/pages/tags/view.php?type=tag&id=",viewthemeurl:M.cfg.wwwroot+"/local/digitalta/pages/tags/view.php?type=theme&id="},paginationArray=(0,_utils.generatePagination)(resourcesResponse.pages,selectedPage);const resourcesList=await _templates.default.renderForPromise("local_digitalta/resources/dashboard/resource-list",obj);pages=resourcesResponse.pages;const paginationList=await _templates.default.renderForPromise("local_digitalta/_common/pagination",{pages:paginationArray,pagesCount:paginationArray.length,currentPage:selectedPage,disablePrevious:selectedPage<=1,disableNext:selectedPage>=pages});_templates.default.replaceNodeContents("#list-resources-body",resourcesList.html,resourcesList.js),_templates.default.replaceNodeContents("#digital-pagination",paginationList.html,paginationList.js),(0,_jquery.default)(".digitalta.pagination").show()}}}));

//# sourceMappingURL=provider.min.js.map