{"version":3,"file":"provider.min.js","sources":["../../src/cases/provider.js"],"sourcesContent":["import Templates from \"core/templates\";\nimport $ from \"jquery\";\nimport Ajax from \"core/ajax\";\nimport { exception as displayException } from \"core/notification\";\n\nlet pages = 0;\nlet filters = [];\n\nlet selectedPage = 1;\n\nexport const init = () => {\n  getCases();\n  $('[data-section-name=\"digitalta-cases-list\"]  .dropdown-menu').on(\"click\", function (e) {\n    e.stopPropagation();\n  });\n  getAndRenderFilters();\n  setActionsFilters();\n};\n\nconst getAndRenderFilters = async () => {\n  const themesRequest = { methodname: \"local_digitalta_themes_get\", args: {} };\n  const tagsRequest = { methodname: \"local_digitalta_tags_get\", args: {} };\n  const languagesRequest = { methodname: \"local_digitalta_cases_get_langs\", args: {} };\n\n  const themesResponse = await Ajax.call([themesRequest])[0];\n  const tagsResponse = await Ajax.call([tagsRequest])[0];\n  const languagesResponse = await Ajax.call([languagesRequest])[0];\n\n  // eslint-disable-next-line max-len\n  const templateFilterThemes = await Templates.renderForPromise(\"local_digitalta/_common/filterTheme\", { themes: themesResponse });\n  // eslint-disable-next-line max-len\n  const templateFilterLanguages = await Templates.renderForPromise(\"local_digitalta/_common/filterLanguages\", {\n    languages: languagesResponse,\n  });\n  Templates.replaceNodeContents(\"#filterThemeSelect\", templateFilterThemes.html, templateFilterThemes.js);\n  Templates.replaceNodeContents(\"#filterLanguageSelect\", templateFilterLanguages.html, templateFilterLanguages.js);\n\n  const availableTags = tagsResponse.map(function (tag) {\n    return tag.name;\n  });\n\n  $(\"#inlineFormInputGroup\").on(\"input\", async function () {\n    var input = $(this).val().toLowerCase();\n    var suggestions = availableTags.filter(function (tag) {\n      return tag.toLowerCase().startsWith(input);\n    });\n\n    const templateFilterTags = await Templates.renderForPromise(\"local_digitalta/_common/listTags\", { tags: suggestions });\n    Templates.replaceNodeContents(\"#suggestionsTags\", templateFilterTags.html, templateFilterTags.js);\n  });\n};\n\nconst setActionsFilters = () => {\n  $(document).on(\"click\", \"li.page-item.page-link.page\", function () {\n    const clickedPage = $(this).attr(\"attr-page\");\n    if (selectedPage !== clickedPage) {\n      selectedPage = parseInt(clickedPage);\n      getCases();\n    }\n  });\n  $(document).on(\"click\", \"li.page-item.page-link.state\", function () {\n    const state = $(this).attr(\"aria-label\");\n    if (state === \"Next\") {\n      const posibleNextPage = selectedPage + 1;\n      if (posibleNextPage > 0 && posibleNextPage <= pages) {\n        selectedPage++;\n        getCases();\n      }\n    } else if (state === \"Previous\") {\n      const posiblePreviousPage = selectedPage - 1;\n      if (posiblePreviousPage > 0 && posiblePreviousPage <= pages) {\n        selectedPage--;\n        getCases();\n      }\n    }\n  });\n  $(document).on(\"change\", \".filterThemeSelect\", function () {\n    const selectedValue = $(\"option:selected.enable\", this).val();\n    const selectedText = $(\"option:selected.enable\", this).text();\n    if (selectedText.length > 0) {\n      const element = $(\"option:selected.enable\", this);\n      element.addClass(\"disabled\");\n      element.removeClass(\"enable\");\n      const filterObject = { type: \"theme\", value: { id: selectedValue, name: selectedText } };\n      setFilter(filterObject);\n      $(\".filterThemeSelect option:first\").prop(\"selected\", true);\n      $(element).prop(\"disabled\", true);\n    }\n  });\n\n  $(\"#suggestionsTags\").on(\"click\", \".tag-item\", function () {\n    const filterText = { type: \"tag\", value: $(this).attr(\"attr-name\") };\n    setFilter(filterText);\n    $(\"#inlineFormInputGroup\").val(\"\");\n  });\n\n  $(document).on(\"keydown\", \"#authorFilters\", async function () {\n    const filterText = $(this).val(); // Obtenemos el valor del input\n    const request = {\n      methodname: \"core_enrol_get_potential_users\",\n      args: { courseid: 1, enrolid: 1, page: 0, perpage: 10, search: filterText, searchanywhere: true },\n    };\n    const response = await Ajax.call([request])[0];\n\n    if (response.length === 0) {\n      $(\"#suggestionsAuthors\").empty();\n    } else {\n      const authorsSuggestions = await Templates.renderForPromise(\"local_digitalta/_common/listAuthors\", { users: response });\n      Templates.replaceNodeContents(\"#suggestionsAuthors\", authorsSuggestions.html, authorsSuggestions.js);\n    }\n  });\n\n  $(\"#suggestionsAuthors\").on(\"click\", \".author-item\", function () {\n    const filterText = { type: \"author\", value: { id: $(this).attr(\"attr-id-user\"), name: $(this).attr(\"attr-name\") } };\n    setFilter(filterText);\n    $(\"#authorFilters\").val(\"\");\n  });\n\n  $(document).on(\"change\", \".filterLanguageSelect\", function () {\n    const selectedText = $(\"option:selected.enable\", this).text();\n    if (selectedText.length > 0) {\n      const element = $(\"option:selected.enable\", this);\n      element.addClass(\"disabled\");\n      element.removeClass(\"enable\");\n      const filterObject = { type: \"language\", value: selectedText };\n      setFilter(filterObject);\n      $(\".filterLanguageSelect option:first\").prop(\"selected\", true);\n      $(element).prop(\"disabled\", true);\n    }\n  });\n\n  $(\"#filters-menu\").click(function () {\n    if ($(\".tagsInputFilter\").is(\":focus\")) {\n      $(\"#suggestionsAuthors\").hide();\n      $(\"#suggestionsTags\").show();\n    } else if ($(\"#authorFilters\").is(\":focus\")) {\n      $(\"#suggestionsTags\").hide();\n      $(\"#suggestionsAuthors\").show();\n    } else {\n      $(\"#suggestionsTags\").hide();\n      $(\"#suggestionsAuthors\").hide();\n    }\n  });\n\n  $(document).on(\"click\", \"#removeFilter\", function () {\n    const filterText = $(this).attr(\"attr-filter\");\n    const filterType = $(this).attr(\"attr-type\");\n    const filterObject = { type: filterType, value: filterText };\n    removeFilter(filterObject);\n  });\n};\n\nconst removeFilter = (filterObject) => {\n  const index = filters.findIndex((filter) => {\n    if (filter.type === \"author\" || filter.type === \"theme\") {\n      return filter.type === filterObject.type && filter.value.name === filterObject.value;\n    } else {\n      return filter.type === filterObject.type && filter.value === filterObject.value;\n    }\n  });\n\n  if (index > -1) {\n    if (filterObject.type === \"theme\") {\n      let themeSelect = $(\"#filterThemes\");\n      let option = $('option[value=\"' + filters[index].value.id + '\"].disabled', themeSelect);\n      option.removeClass(\"disabled\");\n      option.addClass(\"enable\");\n      $(\"#filterThemes option:first\").prop(\"selected\", true);\n      $(option).prop(\"disabled\", false);\n    } else if (filterObject.type === \"language\") {\n      let langSelect = $(\".filterLanguageSelect\");\n      let option = $('option[value=\"' + filterObject.value + '\"].disabled', langSelect);\n      option.removeClass(\"disabled\");\n      option.addClass(\"enable\");\n      $(\".filterLanguageSelect option:first\").prop(\"selected\", true);\n      $(option).prop(\"disabled\", false);\n    }\n    filters.splice(index, 1);\n    selectedPage = 1;\n    renderFilters();\n  }\n};\n\nconst setFilter = (filterObject) => {\n  filters.push(filterObject);\n  selectedPage = 1;\n  renderFilters();\n};\n\nconst renderFilters = () => {\n  getCases();\n  const filtersMap = filters.map((filter) => {\n    if (filter.type === \"author\" || filter.type === \"theme\") {\n      return { type: filter.type, value: filter.value.name };\n    } else {\n      return { type: filter.type, value: filter.value };\n    }\n  });\n  Templates.renderForPromise(\"local_digitalta/_common/filterList\", { filters: filtersMap })\n    .then(({ html, js }) => {\n      Templates.replaceNodeContents(\"#filtersList\", html, js);\n    })\n    .catch((error) => displayException(error));\n};\n\nconst getCases = async () => {\n  const mappedFilters = filters.map((filter) => {\n    if (filter.type === \"author\" || filter.type === \"theme\") {\n      return { type: filter.type, value: filter.value.id };\n    }\n    return filter;\n  });\n\n  const casesRequest = {\n    methodname: \"local_digitalta_cases_get_paginated\",\n    args: {\n      pagenumber: selectedPage,\n      filters: JSON.stringify(mappedFilters),\n    },\n  };\n  const casesResponse = await Ajax.call([casesRequest])[0];\n\n  if (casesResponse.data.length === 0) {\n    Templates.renderForPromise(\"local_digitalta/_common/empty-view\", casesResponse)\n      .then(({ html, js }) => {\n        Templates.replaceNodeContents(\"#list-cases-body\", html, js);\n      })\n      .catch((error) => displayException(error));\n    $(\".digitalta.pagination\").hide();\n  } else {\n    let obj = {\n      cases: casesResponse,\n      \"viewtagurl\": M.cfg.wwwroot + \"/local/digitalta/pages/tags/view.php?type=tag&id=\",\n      \"viewthemeurl\": M.cfg.wwwroot + \"/local/digitalta/pages/tags/view.php?type=theme&id=\"\n    };\n    let paginationArray = generatePagination(casesResponse.pages, selectedPage);\n    const casesList = await Templates.renderForPromise(\"local_digitalta/cases/dashboard/case-list\", obj);\n    pages = casesResponse.pages;\n    const pagination = await Templates.renderForPromise(\"local_digitalta/_common/pagination\", {\n      pages: paginationArray,\n      pagesCount: paginationArray.length,\n      currentPage: selectedPage,\n      disablePrevious: selectedPage <= 1,\n      disableNext: selectedPage >= pages,\n    });\n    Templates.replaceNodeContents(\"#list-cases-body\", casesList.html, casesList.js);\n    Templates.replaceNodeContents(\"#digital-pagination\", pagination.html, pagination.js);\n    $(\".digitalta.pagination\").show();\n  }\n};\n\nconst generatePagination = (totalPages, selectedPage) => {\n  let pagination = [];\n  for (let i = 0; i < totalPages; i++) {\n    let page = {\n      page: i + 1,\n      selected: i + 1 === selectedPage,\n    };\n    pagination.push(page);\n  }\n  return pagination;\n};\n"],"names":["pages","filters","selectedPage","getCases","on","e","stopPropagation","getAndRenderFilters","setActionsFilters","async","themesResponse","Ajax","call","methodname","args","tagsResponse","languagesResponse","templateFilterThemes","Templates","renderForPromise","themes","templateFilterLanguages","languages","replaceNodeContents","html","js","availableTags","map","tag","name","input","this","val","toLowerCase","suggestions","filter","startsWith","templateFilterTags","tags","document","clickedPage","attr","parseInt","state","posibleNextPage","posiblePreviousPage","selectedValue","selectedText","text","length","element","addClass","removeClass","setFilter","type","value","id","prop","filterText","request","courseid","enrolid","page","perpage","search","searchanywhere","response","empty","authorsSuggestions","users","click","is","hide","show","filterType","removeFilter","filterObject","index","findIndex","themeSelect","option","langSelect","splice","renderFilters","push","filtersMap","then","_ref","catch","error","mappedFilters","casesRequest","pagenumber","JSON","stringify","casesResponse","data","_ref2","obj","cases","M","cfg","wwwroot","paginationArray","generatePagination","casesList","pagination","pagesCount","currentPage","disablePrevious","disableNext","totalPages","i","selected"],"mappings":"scAKIA,MAAQ,EACRC,QAAU,GAEVC,aAAe,gBAEC,KAClBC,+BACE,8DAA8DC,GAAG,SAAS,SAAUC,GACpFA,EAAEC,qBAEJC,sBACAC,2BAGID,oBAAsBE,gBAKpBC,qBAAuBC,cAAKC,KAAK,CAJjB,CAAEC,WAAY,6BAA8BC,KAAM,MAIhB,GAClDC,mBAAqBJ,cAAKC,KAAK,CAJjB,CAAEC,WAAY,2BAA4BC,KAAM,MAIhB,GAC9CE,wBAA0BL,cAAKC,KAAK,CAJjB,CAAEC,WAAY,kCAAmCC,KAAM,MAIlB,GAGxDG,2BAA6BC,mBAAUC,iBAAiB,sCAAuC,CAAEC,OAAQV,iBAEzGW,8BAAgCH,mBAAUC,iBAAiB,0CAA2C,CAC1GG,UAAWN,uCAEHO,oBAAoB,qBAAsBN,qBAAqBO,KAAMP,qBAAqBQ,uBAC1FF,oBAAoB,wBAAyBF,wBAAwBG,KAAMH,wBAAwBI,UAEvGC,cAAgBX,aAAaY,KAAI,SAAUC,YACxCA,IAAIC,4BAGX,yBAAyBzB,GAAG,SAASK,qBACjCqB,OAAQ,mBAAEC,MAAMC,MAAMC,cACtBC,YAAcR,cAAcS,QAAO,SAAUP,YACxCA,IAAIK,cAAcG,WAAWN,gBAGhCO,yBAA2BnB,mBAAUC,iBAAiB,mCAAoC,CAAEmB,KAAMJ,iCAC9FX,oBAAoB,mBAAoBc,mBAAmBb,KAAMa,mBAAmBZ,QAI5FjB,kBAAoB,yBACtB+B,UAAUnC,GAAG,QAAS,+BAA+B,iBAC/CoC,aAAc,mBAAET,MAAMU,KAAK,aAC7BvC,eAAiBsC,cACnBtC,aAAewC,SAASF,aACxBrC,mCAGFoC,UAAUnC,GAAG,QAAS,gCAAgC,iBAChDuC,OAAQ,mBAAEZ,MAAMU,KAAK,iBACb,SAAVE,MAAkB,OACdC,gBAAkB1C,aAAe,EACnC0C,gBAAkB,GAAKA,iBAAmB5C,QAC5CE,eACAC,iBAEG,GAAc,aAAVwC,MAAsB,OACzBE,oBAAsB3C,aAAe,EACvC2C,oBAAsB,GAAKA,qBAAuB7C,QACpDE,eACAC,oCAIJoC,UAAUnC,GAAG,SAAU,sBAAsB,iBACvC0C,eAAgB,mBAAE,yBAA0Bf,MAAMC,MAClDe,cAAe,mBAAE,yBAA0BhB,MAAMiB,UACnDD,aAAaE,OAAS,EAAG,OACrBC,SAAU,mBAAE,yBAA0BnB,MAC5CmB,QAAQC,SAAS,YACjBD,QAAQE,YAAY,UAEpBC,UADqB,CAAEC,KAAM,QAASC,MAAO,CAAEC,GAAIV,cAAejB,KAAMkB,oCAEtE,mCAAmCU,KAAK,YAAY,uBACpDP,SAASO,KAAK,YAAY,2BAI9B,oBAAoBrD,GAAG,QAAS,aAAa,iBACvCsD,WAAa,CAAEJ,KAAM,MAAOC,OAAO,mBAAExB,MAAMU,KAAK,cACtDY,UAAUK,gCACR,yBAAyB1B,IAAI,2BAG/BO,UAAUnC,GAAG,UAAW,kBAAkBK,uBAEpCkD,QAAU,CACd9C,WAAY,iCACZC,KAAM,CAAE8C,SAAU,EAAGC,QAAS,EAAGC,KAAM,EAAGC,QAAS,GAAIC,QAHtC,mBAAEjC,MAAMC,MAGkDiC,gBAAgB,IAEvFC,eAAiBvD,cAAKC,KAAK,CAAC+C,UAAU,MAEpB,IAApBO,SAASjB,2BACT,uBAAuBkB,YACpB,OACCC,yBAA2BlD,mBAAUC,iBAAiB,sCAAuC,CAAEkD,MAAOH,8BAClG3C,oBAAoB,sBAAuB6C,mBAAmB5C,KAAM4C,mBAAmB3C,4BAInG,uBAAuBrB,GAAG,QAAS,gBAAgB,iBAC7CsD,WAAa,CAAEJ,KAAM,SAAUC,MAAO,CAAEC,IAAI,mBAAEzB,MAAMU,KAAK,gBAAiBZ,MAAM,mBAAEE,MAAMU,KAAK,eACnGY,UAAUK,gCACR,kBAAkB1B,IAAI,2BAGxBO,UAAUnC,GAAG,SAAU,yBAAyB,iBAC1C2C,cAAe,mBAAE,yBAA0BhB,MAAMiB,UACnDD,aAAaE,OAAS,EAAG,OACrBC,SAAU,mBAAE,yBAA0BnB,MAC5CmB,QAAQC,SAAS,YACjBD,QAAQE,YAAY,UAEpBC,UADqB,CAAEC,KAAM,WAAYC,MAAOR,mCAE9C,sCAAsCU,KAAK,YAAY,uBACvDP,SAASO,KAAK,YAAY,2BAI9B,iBAAiBa,OAAM,YACnB,mBAAE,oBAAoBC,GAAG,+BACzB,uBAAuBC,2BACvB,oBAAoBC,SACb,mBAAE,kBAAkBF,GAAG,+BAC9B,oBAAoBC,2BACpB,uBAAuBC,6BAEvB,oBAAoBD,2BACpB,uBAAuBA,+BAI3BjC,UAAUnC,GAAG,QAAS,iBAAiB,iBACjCsD,YAAa,mBAAE3B,MAAMU,KAAK,eAC1BiC,YAAa,mBAAE3C,MAAMU,KAAK,aAEhCkC,aADqB,CAAErB,KAAMoB,WAAYnB,MAAOG,iBAK9CiB,aAAgBC,qBACdC,MAAQ5E,QAAQ6E,WAAW3C,QACX,WAAhBA,OAAOmB,MAAqC,UAAhBnB,OAAOmB,KAC9BnB,OAAOmB,OAASsB,aAAatB,MAAQnB,OAAOoB,MAAM1B,OAAS+C,aAAarB,MAExEpB,OAAOmB,OAASsB,aAAatB,MAAQnB,OAAOoB,QAAUqB,aAAarB,WAI1EsB,OAAS,EAAG,IACY,UAAtBD,aAAatB,KAAkB,KAC7ByB,aAAc,mBAAE,iBAChBC,QAAS,mBAAE,iBAAmB/E,QAAQ4E,OAAOtB,MAAMC,GAAK,cAAeuB,aAC3EC,OAAO5B,YAAY,YACnB4B,OAAO7B,SAAS,8BACd,8BAA8BM,KAAK,YAAY,uBAC/CuB,QAAQvB,KAAK,YAAY,QACtB,GAA0B,aAAtBmB,aAAatB,KAAqB,KACvC2B,YAAa,mBAAE,yBACfD,QAAS,mBAAE,iBAAmBJ,aAAarB,MAAQ,cAAe0B,YACtED,OAAO5B,YAAY,YACnB4B,OAAO7B,SAAS,8BACd,sCAAsCM,KAAK,YAAY,uBACvDuB,QAAQvB,KAAK,YAAY,GAE7BxD,QAAQiF,OAAOL,MAAO,GACtB3E,aAAe,EACfiF,kBAIE9B,UAAauB,eACjB3E,QAAQmF,KAAKR,cACb1E,aAAe,EACfiF,iBAGIA,cAAgB,KACpBhF,iBACMkF,WAAapF,QAAQ0B,KAAKQ,QACV,WAAhBA,OAAOmB,MAAqC,UAAhBnB,OAAOmB,KAC9B,CAAEA,KAAMnB,OAAOmB,KAAMC,MAAOpB,OAAOoB,MAAM1B,MAEzC,CAAEyB,KAAMnB,OAAOmB,KAAMC,MAAOpB,OAAOoB,4BAGpCpC,iBAAiB,qCAAsC,CAAElB,QAASoF,aACzEC,MAAKC,WAAC/D,KAAEA,KAAFC,GAAQA,4BACHF,oBAAoB,eAAgBC,KAAMC,OAErD+D,OAAOC,QAAU,2BAAiBA,UAGjCtF,SAAWM,gBACTiF,cAAgBzF,QAAQ0B,KAAKQ,QACb,WAAhBA,OAAOmB,MAAqC,UAAhBnB,OAAOmB,KAC9B,CAAEA,KAAMnB,OAAOmB,KAAMC,MAAOpB,OAAOoB,MAAMC,IAE3CrB,SAGHwD,aAAe,CACnB9E,WAAY,sCACZC,KAAM,CACJ8E,WAAY1F,aACZD,QAAS4F,KAAKC,UAAUJ,iBAGtBK,oBAAsBpF,cAAKC,KAAK,CAAC+E,eAAe,MAEpB,IAA9BI,cAAcC,KAAK/C,0BACX9B,iBAAiB,qCAAsC4E,eAC9DT,MAAKW,YAACzE,KAAEA,KAAFC,GAAQA,6BACHF,oBAAoB,mBAAoBC,KAAMC,OAEzD+D,OAAOC,QAAU,2BAAiBA,6BACnC,yBAAyBjB,WACtB,KACD0B,IAAM,CACRC,MAAOJ,yBACOK,EAAEC,IAAIC,QAAU,iEACdF,EAAEC,IAAIC,QAAU,uDAE9BC,gBAAkBC,mBAAmBT,cAAc/F,MAAOE,oBACxDuG,gBAAkBvF,mBAAUC,iBAAiB,4CAA6C+E,KAChGlG,MAAQ+F,cAAc/F,YAChB0G,iBAAmBxF,mBAAUC,iBAAiB,qCAAsC,CACxFnB,MAAOuG,gBACPI,WAAYJ,gBAAgBtD,OAC5B2D,YAAa1G,aACb2G,gBAAiB3G,cAAgB,EACjC4G,YAAa5G,cAAgBF,2BAErBuB,oBAAoB,mBAAoBkF,UAAUjF,KAAMiF,UAAUhF,uBAClEF,oBAAoB,sBAAuBmF,WAAWlF,KAAMkF,WAAWjF,wBAC/E,yBAAyBgD,SAIzB+B,mBAAqB,CAACO,WAAY7G,oBAClCwG,WAAa,OACZ,IAAIM,EAAI,EAAGA,EAAID,WAAYC,IAAK,KAC/BlD,KAAO,CACTA,KAAMkD,EAAI,EACVC,SAAUD,EAAI,IAAM9G,cAEtBwG,WAAWtB,KAAKtB,aAEX4C"}