define("local_digitalta/experiences/provider",["exports","core/notification","core/templates","jquery","core/ajax"],(function(_exports,_notification,_templates,_jquery,_ajax){function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}Object.defineProperty(_exports,"__esModule",{value:!0}),_exports.init=void 0,_templates=_interopRequireDefault(_templates),_jquery=_interopRequireDefault(_jquery),_ajax=_interopRequireDefault(_ajax);let pages=0,filters=[],selectedPage=1;_exports.init=()=>{getAndRenderFilters(),getExperiences(),(0,_jquery.default)(".dropdown-menu").on("click",(function(e){e.stopPropagation()})),(0,_jquery.default)(document).on("click","li.page-item.page-link.page",(function(){const clickedPage=(0,_jquery.default)(this).attr("attr-page");selectedPage!==clickedPage&&(selectedPage=parseInt(clickedPage),getExperiences())})),(0,_jquery.default)(document).on("click","li.page-item.page-link.state",(function(){const state=(0,_jquery.default)(this).attr("aria-label");if("Next"===state){const posibleNextPage=selectedPage+1;posibleNextPage>0&&posibleNextPage<=pages&&(selectedPage++,getExperiences())}else if("Previous"===state){const posiblePreviousPage=selectedPage-1;posiblePreviousPage>0&&posiblePreviousPage<=pages&&(selectedPage--,getExperiences())}})),(0,_jquery.default)(document).on("change",".filterThemeSelect",(function(){const selectedValue=(0,_jquery.default)("option:selected.enable",this).val(),selectedText=(0,_jquery.default)("option:selected.enable",this).text();if(selectedText.length>0){const element=(0,_jquery.default)("option:selected.enable",this);element.addClass("disabled"),element.removeClass("enable");setFilter({type:"theme",value:{id:selectedValue,name:selectedText}}),(0,_jquery.default)(".filterThemeSelect option:first").prop("selected",!0),(0,_jquery.default)(element).prop("disabled",!0)}})),(0,_jquery.default)(document).on("change",".filterLanguageSelect",(function(){const selectedText=(0,_jquery.default)("option:selected.enable",this).text();if(selectedText.length>0){const element=(0,_jquery.default)("option:selected.enable",this);element.addClass("disabled"),element.removeClass("enable");setFilter({type:"language",value:selectedText}),(0,_jquery.default)(".filterLanguageSelect option:first").prop("selected",!0),(0,_jquery.default)(element).prop("disabled",!0)}})),(0,_jquery.default)(document).on("keydown","#inlineFormInputGroup",(function(event){if("Enter"===event.key||13===event.keyCode){const filterText=(0,_jquery.default)(this).val();setFilter({type:"tag",value:filterText}),(0,_jquery.default)(this).val("")}})),(0,_jquery.default)(document).on("keydown","#autorFilters",(async function(){const request={methodname:"core_enrol_get_potential_users",args:{courseid:1,enrolid:1,page:0,perpage:10,search:(0,_jquery.default)(this).val(),searchanywhere:!0}},response=await _ajax.default.call([request])[0];if(0===response.length)(0,_jquery.default)("#suggestionsAutors").empty();else{const authorsSuggestions=await _templates.default.renderForPromise("local_digitalta/_common/listAutors",{users:response});_templates.default.replaceNodeContents("#suggestionsAutors",authorsSuggestions.html,authorsSuggestions.js)}})),(0,_jquery.default)("#suggestionsTags").on("click",".tag-item",(function(){const filterText={type:"tag",value:(0,_jquery.default)(this).attr("attr-name")};setFilter(filterText),(0,_jquery.default)("#inlineFormInputGroup").val("")})),(0,_jquery.default)("#suggestionsAutors").on("click",".autor-item",(function(){const filterText={type:"author",value:{id:(0,_jquery.default)(this).attr("attr-id-user"),name:(0,_jquery.default)(this).attr("attr-name")}};setFilter(filterText),(0,_jquery.default)("#autorFilters").val("")})),(0,_jquery.default)("#filters-menu").click((function(){(0,_jquery.default)(".tagsInputFilter").is(":focus")?((0,_jquery.default)("#suggestionsAutors").hide(),(0,_jquery.default)("#suggestionsTags").show()):(0,_jquery.default)("#autorFilters").is(":focus")?((0,_jquery.default)("#suggestionsTags").hide(),(0,_jquery.default)("#suggestionsAutors").show()):((0,_jquery.default)("#suggestionsTags").hide(),(0,_jquery.default)("#suggestionsAutors").hide())})),(0,_jquery.default)(document).on("click","#removeFilter",(function(){const filterText=(0,_jquery.default)(this).attr("attr-filter"),filterType=(0,_jquery.default)(this).attr("attr-type");removeFilter({type:filterType,value:filterText})}))};const getExperiences=async()=>{const mappedFilters=filters.map((filter=>"author"===filter.type||"theme"===filter.type?{type:filter.type,value:filter.value.id}:filter)),request={methodname:"local_digitalta_experiences_get_by_pagination",args:{pagenumber:selectedPage,filters:JSON.stringify(mappedFilters)}},response=await _ajax.default.call([request])[0];if(0===response.data.length)_templates.default.renderForPromise("local_digitalta/_common/empty-view",response).then((_ref=>{let{html:html,js:js}=_ref;_templates.default.replaceNodeContents("#list-experience-body",html,js)})).catch((error=>(0,_notification.exception)(error))),(0,_jquery.default)(".digitalta.pagination").hide();else{let obj={experiences:response},paginationArray=generatePagination(response.pages,selectedPage);const experienceList=await _templates.default.renderForPromise("local_digitalta/experiences/dashboard/experience-list",obj);pages=response.pages;const pagination=await _templates.default.renderForPromise("local_digitalta/_common/pagination",{pages:paginationArray});_templates.default.replaceNodeContents("#list-experience-body",experienceList.html,experienceList.js),_templates.default.replaceNodeContents("#digital-pagination",pagination.html,pagination.js),(0,_jquery.default)(".digitalta.pagination").show()}},generatePagination=(totalPages,selectedPage)=>{let pagination=[];for(let i=0;i<totalPages;i++){let page={page:i+1,selected:i+1===selectedPage};pagination.push(page)}return pagination},getAndRenderFilters=async()=>{const themesResponse=await _ajax.default.call([{methodname:"local_digitalta_themes_get",args:{}}])[0],tagsResponse=await _ajax.default.call([{methodname:"local_digitalta_tags_get",args:{}}])[0],languagesResponse=await _ajax.default.call([{methodname:"local_digitalta_experiences_get_used_langs",args:{}}])[0],templateFilterThemes=await _templates.default.renderForPromise("local_digitalta/_common/filterTheme",{themes:themesResponse}),templateFilterLanguages=await _templates.default.renderForPromise("local_digitalta/_common/filterLanguages",{languages:languagesResponse});_templates.default.replaceNodeContents("#filterThemeSelect",templateFilterThemes.html,templateFilterThemes.js),_templates.default.replaceNodeContents("#filterLanguageSelect",templateFilterLanguages.html,templateFilterLanguages.js);const availableTags=tagsResponse.map((function(tag){return tag.name}));(0,_jquery.default)("#inlineFormInputGroup").on("input",(async function(){var input=(0,_jquery.default)(this).val().toLowerCase(),suggestions=availableTags.filter((function(tag){return tag.toLowerCase().startsWith(input)}));const templateFilterTags=await _templates.default.renderForPromise("local_digitalta/_common/listTags",{tags:suggestions});_templates.default.replaceNodeContents("#suggestionsTags",templateFilterTags.html,templateFilterTags.js)}))},setFilter=filterObject=>{filters.push(filterObject),selectedPage=1,renderFilters()},removeFilter=filterObject=>{const index=filters.findIndex((filter=>"author"===filter.type||"theme"===filter.type?filter.type===filterObject.type&&filter.value.name===filterObject.value:filter.type===filterObject.type&&filter.value===filterObject.value));if(index>-1){if("theme"===filterObject.type){let themeSelect=(0,_jquery.default)("#filterThemes"),option=(0,_jquery.default)('option[value="'+filters[index].value.id+'"].disabled',themeSelect);option.removeClass("disabled"),option.addClass("enable"),(0,_jquery.default)("#filterThemes option:first").prop("selected",!0),(0,_jquery.default)(option).prop("disabled",!1)}else if("language"===filterObject.type){let langSelect=(0,_jquery.default)(".filterLanguageSelect"),option=(0,_jquery.default)('option[value="'+filterObject.value+'"].disabled',langSelect);option.removeClass("disabled"),option.addClass("enable"),(0,_jquery.default)(".filterLanguageSelect option:first").prop("selected",!0),(0,_jquery.default)(option).prop("disabled",!1)}filters.splice(index,1),selectedPage=1,renderFilters()}},renderFilters=()=>{getExperiences();const filtersMap=filters.map((filter=>"author"===filter.type||"theme"===filter.type?{type:filter.type,value:filter.value.name}:{type:filter.type,value:filter.value}));_templates.default.renderForPromise("local_digitalta/_common/filterList",{filters:filtersMap}).then((_ref2=>{let{html:html,js:js}=_ref2;_templates.default.replaceNodeContents("#filtersList",html,js)})).catch((error=>(0,_notification.exception)(error)))}}));

//# sourceMappingURL=provider.min.js.map